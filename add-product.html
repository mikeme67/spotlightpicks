<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Add Product - Spotlight Picks</title>
<link rel="stylesheet" href="style.css">
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<style>
.header{display:flex;align-items:center;justify-content:space-between;padding:10px 18px;background:linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.88));backdrop-filter: blur(8px)}
.container-card{max-width:640px;margin:28px auto;padding:18px;background:#fff;border-radius:14px;box-shadow:0 12px 30px rgba(0,0,0,0.06)}
input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid #eee;margin-top:8px}
.btn{padding:12px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-weight:700;margin-top:12px;cursor:pointer}
.auto-status{font-size:13px;color:#666;margin-top:8px}
.images-preview{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.img-card{width:100px;height:80px;border-radius:8px;overflow:hidden;border:1px solid #f0e0e8;display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
<div class="header">
  <div class="brand-left">
    <div class="logo">Spotlight Picks</div>
  </div>
</div>

<div class="container-card">
  <h2 style="margin:0 0 8px 0">Add Product (auto-fill or manual)</h2>
  <label>Product page URL</label>
  <div style="display:flex;gap:8px">
    <input id="inputUrl" placeholder="https://example.com/product/123">
    <button id="autofillBtn" class="btn" style="width:160px;background:var(--accent);">Auto-fill</button>
  </div>
  <div class="auto-status" id="autoStatus">Paste a product link above (optional)</div>

  <label style="margin-top:12px">Product Name</label>
  <input id="p_name" placeholder="Name">

  <label>Category (hoodies, shirts, pants)</label>
  <select id="p_cat"><option>hoodies</option><option>shirts</option><option>pants</option><option>sweats</option><option>other</option></select>

  <label>Price</label>
  <input id="p_price" placeholder="$39.99">

  <label>Image URLs (comma separated)</label>
  <textarea id="p_images" placeholder="https://.../img1.jpg, https://.../img2.jpg"></textarea>
  <div class="images-preview" id="imagesPreview"></div>

  <label>Store link</label>
  <input id="p_link">

  <label>Description</label>
  <textarea id="p_desc"></textarea>

  <label>Initial reviews (comma separated)</label>
  <input id="p_reviews">

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
    <button id="saveBtn" class="btn" style="flex:1;background:var(--accent-2)">Save (local)</button>
    <button id="downloadBtn" class="btn" style="flex:1;background:#fff;color:var(--accent);border:1px solid rgba(0,0,0,0.06)">Download JSON</button>
    <button id="publishBtn" class="btn" style="flex:1">Prepare Publish</button>
  </div>

  <label style="margin-top:12px">Publish JSON (copy/paste into repo products.json)</label>
  <textarea id="publishBox" style="width:100%;height:180px;border-radius:10px;border:1px solid #eee;margin-top:8px" readonly></textarea>

  <div style="margin-top:12px">
    <h3>Saved (local) products</h3>
    <div id="productList"></div>
  </div>
</div>

<script src="app.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=> {
  app.updateProfileButtons('topProfileBtn','bottomProfileBtn');
  app.setupSearch();
  const inputUrl = document.getElementById('inputUrl'), autofillBtn = document.getElementById('autofillBtn'), autoStatus = document.getElementById('autoStatus');
  const p_name = document.getElementById('p_name'), p_cat = document.getElementById('p_cat'), p_price = document.getElementById('p_price'), p_images = document.getElementById('p_images'), p_link = document.getElementById('p_link'), p_desc = document.getElementById('p_desc'), p_reviews = document.getElementById('p_reviews');
  const saveBtn = document.getElementById('saveBtn'), downloadBtn = document.getElementById('downloadBtn'), publishBtn = document.getElementById('publishBtn'), publishBox = document.getElementById('publishBox'), imagesPreview = document.getElementById('imagesPreview'), productList = document.getElementById('productList');

  function renderList(){ const arr = app.loadLocalProducts(); productList.innerHTML=''; arr.slice().reverse().forEach(p=>{ const d = document.createElement('div'); d.style.display='flex'; d.style.alignItems='center'; d.style.gap='12px'; d.style.padding='8px'; d.style.border='1px solid #f0e0e8'; d.style.borderRadius='8px'; d.style.marginBottom='8px'; d.innerHTML=`<img src="${p.images[0]||'https://via.placeholder.com/150'}" style="width:64px;height:64px;object-fit:cover;border-radius:8px"><div style="min-width:0"><strong>${app.escapeHtml(p.name)}</strong><div style="font-size:13px;color:#666">${app.escapeHtml(p.category)} • ${app.escapeHtml(p.price||'')}</div></div><div style="margin-left:auto;display:flex;gap:8px"><button onclick="location.href='product.html?id=${p.id}'">View</button><button onclick="editProduct('${p.id}')">Edit</button><button onclick="deleteProduct('${p.id}')">Delete</button></div>`; productList.appendChild(d); }); }
  window.deleteProduct = function(id){ if(!confirm('Delete?')) return; const arr = app.loadLocalProducts().filter(x=>x.id!==id); app.saveLocalProducts(arr); renderList(); }
  window.editProduct = function(id){ const p = app.loadLocalProducts().find(x=>x.id===id); if(!p) return alert('Not found'); p_name.value=p.name; p_cat.value=p.category; p_price.value=p.price; p_images.value=(p.images||[]).join(', '); p_link.value=p.link||''; p_desc.value=p.description||''; p_reviews.value=(p.reviews||[]).join(', '); const arr = app.loadLocalProducts().filter(x=>x.id!==id); app.saveLocalProducts(arr); window.scrollTo({top:0,behavior:'smooth'}); }

  async function tryAutoFill(url){
    autoStatus.textContent = 'Fetching...';
    try{
      // LinkPreview (replace YOUR_API_KEY with your key)
      const res = await fetch(`https://api.linkpreview.net/?key=YOUR_API_KEY&q=${encodeURIComponent(url)}`);
      const data = await res.json();
      if(data.title) p_name.value = data.title;
      if(data.description) p_desc.value = data.description;
      if(data.image) p_images.value = data.image;
      if(!p_link.value) p_link.value = url;
      imagesPreview.innerHTML = (p_images.value||'').split(/[\n,]+/).filter(Boolean).map(u=>`<div class="img-card"><img src="${u}" style="width:100%;height:100%;object-fit:cover"></div>`).join('');
      autoStatus.textContent = 'Auto-fill successful (edit if needed).';
    }catch(e){
      console.log(e);
      autoStatus.textContent = 'Auto-fill failed (CORS or unsupported). Fill fields manually.';
    }
  }

  autofillBtn.addEventListener('click', ()=> {
    const url = inputUrl.value.trim();
    if(!url) return alert('Paste a product URL first');
    tryAutoFill(url);
  });

  saveBtn.addEventListener('click', ()=> {
    const name = p_name.value.trim(); if(!name) return alert('Name required');
    const imgs = (p_images.value||'').split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
    const prod = { id:'p_'+Date.now(), name, category: p_cat.value||'other', price: p_price.value.trim(), images: imgs, link: p_link.value.trim(), description: p_desc.value.trim(), reviews: (p_reviews.value||'').split(',').map(s=>s.trim()).filter(Boolean) };
    app.saveProductLocally(prod);
    autoStatus.textContent = 'Saved locally — redirecting...';
    setTimeout(()=> window.location.href = 'index.html?newProduct=' + encodeURIComponent(prod.id), 600);
  });

  downloadBtn.addEventListener('click', ()=>{
    const imgs = (p_images.value||'').split(/[\n,]+/).map(s=>s.trim()).filter(Boolean);
    const prod = { id:'p_'+Date.now(), name: p_name.value||'', category: p_cat.value, price: p_price.value||'', images: imgs, link: p_link.value||'', description: p_desc.value||'', reviews: (p_reviews.value||'').split(',').map(s=>s.trim()).filter(Boolean) };
    const blob = new Blob([JSON.stringify(prod,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'product-'+(prod.name||'item')+'.json'; document.body.appendChild(a); a.click(); a.remove();
  });

  publishBtn.addEventListener('click', async ()=>{
    const repo = await app.fetchProductsJson();
    const local = app.loadLocalProducts();
    const merged = [...repo];
    local.forEach(lp => { if(!merged.some(r=>r.id===lp.id)) merged.push(lp) });
    publishBox.value = JSON.stringify({products: merged}, null, 2);
    alert('JSON prepared — copy the text in the box and replace products.json in your repo to publish.');
  });

  // live preview of images textarea
  p_images.addEventListener('input', ()=> {
    imagesPreview.innerHTML = (p_images.value||'').split(/[\n,]+/).filter(Boolean).map(u=>`<div class="img-card"><img src="${u}" style="width:100%;height:100%;object-fit:cover"></div>`).join('');
  });

  renderList();
});
</script>
</body>
</html>
